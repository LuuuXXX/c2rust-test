name: Publish to crates.io

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache Rust build artifacts
        uses: Swatinem/rust-cache@v2
      
      - name: Validate tag version matches Cargo.toml
        run: |
          # Use GITHUB_REF, which for tag pushes looks like "refs/tags/v1.2.3"
          TAG_REF="${GITHUB_REF:-}"
          
          if [[ "$TAG_REF" == refs/tags/v* ]]; then
            TAG_VERSION="${TAG_REF#refs/tags/v}"
            
            if [[ ! -f Cargo.toml ]]; then
              echo "Error: Cargo.toml not found in repository root."
              exit 1
            fi
            
            CARGO_VERSION="$(grep -m1 '^version\s*=' Cargo.toml | sed -E 's/^[^"]*"([^"]*)".*/\1/')"
            
            if [[ -z "$CARGO_VERSION" ]]; then
              echo "Error: Could not determine version from Cargo.toml."
              exit 1
            fi
            
            echo "Tag version:    $TAG_VERSION"
            echo "Cargo.toml v.:  $CARGO_VERSION"
            
            if [[ "$TAG_VERSION" != "$CARGO_VERSION" ]]; then
              echo "Error: Git tag version (v$TAG_VERSION) does not match Cargo.toml version ($CARGO_VERSION)."
              exit 1
            fi
          else
            echo "No version tag detected in GITHUB_REF ('$TAG_REF'); skipping tag/version validation."
          fi
      
      - name: Run tests
        run: cargo test
      
      - name: Publish to crates.io
        run: cargo publish --no-verify --token ${{ secrets.CRATES_IO_TOKEN }}

